# !!!!!!!! AUTO-GENERATED FILE, DO NOT MODIFY !!!!!!!!
# This file can be regenerated by the following command:
#   $ nix run .#gen-config

jobs:
  build-nixos-configuration:
    environment: deploy
    needs:
      - check-flake-and-formatter
      - check-eval-host
    runs-on: ubuntu-latest
    steps:
      - if: ${{ github.event.inputs.host == 'all' || (matrix.host == github.event.inputs.host)
          }}
        name: Checkout
        uses: actions/checkout@v3
      - if: ${{ github.event.inputs.host == 'all' || (matrix.host == github.event.inputs.host)
          }}
        name: Make more space
        run: 'echo "=== Before pruning ==="

          df -h

          sudo rm -rf /usr/share /usr/local /opt || true

          echo

          echo "=== After pruning ==="

          df -h

          '
      - if: ${{ github.event.inputs.host == 'all' || (matrix.host == github.event.inputs.host)
          }}
        name: Install Nix
        uses: cachix/install-nix-action@v22
        with:
          github_access_token: ${{ secrets.GITHUB_TOKEN }}
      - if: ${{ github.event.inputs.host == 'all' || (matrix.host == github.event.inputs.host)
          }}
        name: Setup Attic
        uses: icewind1991/attic-action@v1.1
        with:
          authToken: ${{ secrets.ATTIC_HELLO_TOKEN }}
          instance: https://attic.edgerunners.eu.org
          name: hello
      - if: ${{ github.event.inputs.host == 'all' || (matrix.host == github.event.inputs.host)
          }}
        name: Build host
        run: 'nix build .#nixosConfigurations.${{ matrix.host }}.config.system.build.toplevel

          '
    strategy:
      matrix:
        host:
          - dui
          - ge
          - lei
          - xun
          - zheng
  check-eval-host:
    needs: check-flake-and-formatter
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Install Nix
        uses: cachix/install-nix-action@v22
        with:
          github_access_token: ${{ secrets.GITHUB_TOKEN }}
      - name: Eval
        run: 'nix eval --raw .#nixosConfigurations.${{ matrix.host }}.config.system.build.toplevel

          '
    strategy:
      fail-fast: false
      matrix:
        host:
          - dui
          - ge
          - lei
          - xun
          - zheng
  check-flake-and-formatter:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Install Nix
        uses: cachix/install-nix-action@v22
        with:
          github_access_token: ${{ secrets.GITHUB_TOKEN }}
      - name: Check
        run: nix flake check --verbose --print-build-logs
name: Build
on:
  push: {}
  workflow_dispatch:
    inputs:
      host:
        default: all
        description: Host to build
        options:
          - dui
          - ge
          - lei
          - xun
          - zheng
          - all
        required: true
        type: choice
